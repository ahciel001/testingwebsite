# Creation Log Maker
© 2026 The Starry Shore. All Rights Reserved
<style>
    /* --- WRAPPER --- */
    .ss-card {
        max-width: 100%; 
        background: #1e293b; /* Dark Slate */
        border: 2px solid #475569; /* Slate Border */
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        color: #e2e8f0;
        margin-bottom: 20px;
        box-sizing: border-box;
    }

    .ss-card *, .ss-card *::before, .ss-card *::after { box-sizing: border-box; }

    /* --- LAYOUT GRID --- */
    .ss-layout-container {
        display: grid;
        grid-template-columns: 2.5fr 1fr; /* Inputs get more space, Output gets less */
        gap: 20px;
    }

    /* Stack them if the screen is too small */
    @media (max-width: 850px) {
        .ss-layout-container { grid-template-columns: 1fr; }
    }

    /* --- TYPOGRAPHY --- */
    .ss-title {
        font-size: 1.5em; color: #f59e0b; margin: 0 0 5px 0;
        text-transform: uppercase; letter-spacing: 1px;
    }
    .ss-subtitle { color: #94a3b8; font-size: 0.85em; margin: 0 0 20px 0; font-style: italic; border-bottom: 1px solid #475569; padding-bottom: 15px; }
    
    .ss-section-header {
        color: #f59e0b; font-size: 1.1em; border-bottom: 1px dashed #475569;
        padding-bottom: 5px; margin-top: 0; margin-bottom: 15px; text-transform: uppercase;
    }

    /* --- FORMS --- */
    .ss-form-group { margin-bottom: 12px; }
    .ss-label { display: block; margin-bottom: 4px; font-weight: bold; color: #94a3b8; font-size: 0.85em; }
    
    .ss-input, .ss-select, .ss-textarea {
        width: 100%; padding: 8px; background: #0f172a; border: 1px solid #475569;
        color: #fff; border-radius: 6px; font-size: 0.9em; font-family: inherit;
    }
    .ss-input:focus, .ss-select:focus, .ss-textarea:focus { outline: none; border-color: #f59e0b; box-shadow: 0 0 8px rgba(245, 158, 11, 0.3); }

    /* Specific Layouts */
    .ss-grid-2 { display: grid; grid-template-columns: 1fr 3fr; gap: 10px; }
    .ss-import-row { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; }
    
    /* --- BUTTONS --- */
    .ss-btn { padding: 8px 12px; font-size: 0.85em; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; color: #fff; text-transform: uppercase; transition: 0.2s; }
    .ss-btn-primary { background: linear-gradient(145deg, #d97706, #b45309); width: 100%; }
    .ss-btn-primary:hover { background: linear-gradient(145deg, #f59e0b, #d97706); }
    .ss-btn-blue { background: linear-gradient(145deg, #3b82f6, #1d4ed8); white-space: nowrap;}
    .ss-btn-blue:hover { background: linear-gradient(145deg, #60a5fa, #2563eb); }
    .ss-btn-green { background: linear-gradient(145deg, #22c55e, #15803d); width: 100%; }
    .ss-btn-green:hover { background: linear-gradient(145deg, #4ade80, #16a34a); }
    .ss-btn-remove { background: #ef4444; padding: 5px 10px; }
    .ss-btn-remove:hover { background: #dc2626; }
    .ss-btn-add { background: transparent; border: 1px dashed #f59e0b; color: #f59e0b; width: 100%; margin-top: 8px; }
    .ss-btn-add:hover { background: rgba(245, 158, 11, 0.1); }

    /* --- COMPLEXITY HIDING --- */
    .ss-hidden { display: none !important; }
    .ss-show { display: grid !important; }
    
    /* 50/50 SPLIT FOR OTHER INPUTS */
    .ss-input-combo { display: flex; gap: 5px; }
    .ss-input-combo select { flex: 1; min-width: 0; }
    .ss-input-combo .other-input { display: none; flex: 1; min-width: 0; }
    .ss-input-combo.show-other .other-input { display: block; animation: fadein 0.3s; }

    /* --- DYNAMIC ELEMENTS --- */
    .ss-class-row { background: rgba(0,0,0,0.2); border: 1px solid #475569; padding: 8px; border-radius: 6px; margin-bottom: 8px; }
    .ss-class-controls { display: flex; gap: 5px; align-items: center; }
    .ss-class-controls select { flex: 2; }
    .ss-class-controls input[type="number"] { width: 50px; text-align: center; }
    .ss-other-inputs-row { display: none; grid-template-columns: 1fr 1fr; gap: 5px; margin-top: 5px; border-top: 1px dashed #475569; padding-top: 5px; }

    .ss-point-buy-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 4px; background: #0f172a; padding: 5px; border-radius: 6px; border: 1px solid #475569; text-align: center; }
    .ss-stat-item label { font-size: 0.65em; color: #f59e0b; display: block; margin-bottom: 2px;}
    .ss-stat-item select { padding: 2px; text-align: center; width: 100%; font-size: 0.85em; }
    .ss-points-display { grid-column: 1 / -1; margin-top: 5px; font-weight: bold; font-family: monospace; font-size: 0.8em; }
    .ss-valid { color: #4ade80; }
    .ss-invalid { color: #ef4444; }

    /* --- UPDATED PILLS (6 PER ROW) --- */
    .ss-pill-container { 
        display: grid; 
        grid-template-columns: repeat(6, 1fr); /* Force 6 Columns */
        gap: 5px; 
    }
    
    .ss-pill-item {
        display: block; /* Takes full grid cell */
    }

    .ss-pill-item input { display: none; }
    
    .ss-pill-item label {
        display: flex;
        justify-content: center;
        align-items: center;
        text-align: center;
        width: 100%;
        height: 100%;
        padding: 4px 2px;
        
        border: 1px solid #475569;
        background: rgba(0,0,0,0.3);
        border-radius: 6px; /* Slightly squarer for grid alignment */
        
        font-size: 0.7em; /* Smaller font to fit words */
        line-height: 1.1;
        color: #94a3b8;
        cursor: pointer;
        user-select: none;
        transition: all 0.2s;
        word-break: break-word; /* Wrap long words if absolutely necessary */
    }

    /* On very small mobile screens, drop to 3 columns to prevent unreadable text */
    @media (max-width: 500px) {
        .ss-pill-container { grid-template-columns: repeat(3, 1fr); }
    }

    /* Hover State */
    .ss-pill-item label:hover {
        border-color: #64748b;
        color: #e2e8f0;
    }

    /* Checked State */
    .ss-pill-item input:checked + label {
        background: #0ea5e9; /* Sky Blue */
        border-color: #0ea5e9;
        color: #fff;
        font-weight: bold;
        box-shadow: 0 0 8px rgba(14, 165, 233, 0.4);
    }
    
    /* Expertise Color Distinction */
    #expertiseGrid .ss-pill-item input:checked + label {
        background: #a855f7; /* Purple */
        border-color: #a855f7;
        box-shadow: 0 0 8px rgba(168, 85, 247, 0.4);
    }

    /* --- OUTPUT SIDE --- */
    .ss-output-panel { position: sticky; top: 20px; } 
    .ss-output-area { background: #0f172a; color: #cbd5e1; font-family: monospace; padding: 10px; border: 1px solid #475569; border-radius: 6px; width: 100%; height: 500px; resize: vertical; margin-top: 10px; font-size: 0.85em; }

    .ss-import-info { font-size: 0.75em; color: #94a3b8; margin-top: 5px; font-style: italic; }
    .ss-status-msg { margin-top: 5px; font-weight: bold; font-size: 0.8em; min-height: 20px; }
    .ss-bg-asi { background: rgba(0,0,0,0.2); padding: 5px; border-radius: 4px; margin-top: 5px; border: 1px solid #475569;}
    .ss-bg-asi-selects { display: flex; gap: 5px; margin-top: 5px; }

    /* Toast */
    .ss-toast { visibility: hidden; min-width: 250px; background-color: #f59e0b; color: #000; text-align: center; border-radius: 4px; padding: 12px; position: fixed; z-index: 100; left: 50%; bottom: 30px; transform: translateX(-50%); font-weight: bold; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
    .ss-toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
    @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
    @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
</style>

<div class="ss-card">
    <h1 class="ss-title">Creation Log Maker</h1>
    <p class="ss-subtitle">The Starry Shore</p>

    <!-- MAIN GRID CONTAINER -->
    <div class="ss-layout-container">
        
        <!-- LEFT COLUMN: INPUTS -->
        <div class="ss-input-panel">
            <!-- CLEAR BUTTON (No Confirmation) -->
            <div style="display: flex; justify-content: flex-end; margin-bottom: 10px;">
                <button type="button" class="ss-btn ss-btn-remove" onclick="clearAllData()">⚠ Clear All</button>
            </div>

            <div class="ss-section-header">1. Import from beyond (Optional)</div>
            <div class="ss-import-row">
                <input type="text" id="charUrl" class="ss-input" placeholder="D&D Beyond URL...">
                <button class="ss-btn ss-btn-blue" onclick="fetchCharacter()">Fetch</button>
            </div>
            <p class="ss-import-info">Import data from your Beyond sheet. <strong>Please double check</strong>, especially the Skills section and missing Background bonuses! </p>
            <div id="statusMsg" class="ss-status-msg"></div>

            <div class="ss-section-header" style="margin-top:20px;">2. Details</div>
            <form id="charForm">
                <div class="ss-grid-2">
                    <div class="ss-form-group">
                        <label class="ss-label">Char #</label>
                        <input type="text" id="charNum" class="ss-input" placeholder="001">
                    </div>
                    <div class="ss-form-group">
                        <label class="ss-label">Name</label>
                        <input type="text" id="charName" class="ss-input">
                    </div>
                </div>

                <div class="ss-form-group">
                    <label class="ss-label">Classes</label>
                    <div id="classesContainer"></div>
                    <button type="button" class="ss-btn ss-btn-add" onclick="addClassRow()">+ Multiclass</button>
                </div>

                <div class="ss-form-group">
                    <label class="ss-label">Species</label>
                    <div class="ss-input-combo" id="speciesCombo">
                        <select id="charSpecies" class="ss-select"></select>
                        <input type="text" id="charSpeciesOther" class="ss-input other-input" placeholder="Type Species...">
                    </div>
                </div>

                <div class="ss-form-group">
                    <label class="ss-label">Background</label>
                    <div class="ss-input-combo" id="bgCombo">
                        <select id="charBackground" class="ss-select"></select>
                        <input type="text" id="charBgOther" class="ss-input other-input" placeholder="Type Background...">
                    </div>
                    
                    <div class="ss-bg-asi">
                        <label class="ss-label" style="font-size:0.7em; color:#94a3b8;">BG Ability Bonuses</label>
                        <select id="bgBonusType" class="ss-select" onchange="updateBgBonusInputs()" style="margin-bottom:5px;">
                            <option value="none">None / Standard Rule</option>
                            <option value="2_1">+2 / +1 Choice</option>
                            <option value="1_1_1">+1 / +1 / +1 Choice</option>
                        </select>
                        <div id="bgBonusInputs" class="ss-bg-asi-selects ss-hidden"></div>
                    </div>
                </div>

                <div class="ss-form-group">
                    <label class="ss-label">Ability Scores (27 pts)</label>
                    <div class="ss-point-buy-grid">
                        <div class="ss-stat-item"><label>STR</label><select class="ss-select" id="statStr" onchange="calculatePoints()"></select></div>
                        <div class="ss-stat-item"><label>DEX</label><select class="ss-select" id="statDex" onchange="calculatePoints()"></select></div>
                        <div class="ss-stat-item"><label>CON</label><select class="ss-select" id="statCon" onchange="calculatePoints()"></select></div>
                        <div class="ss-stat-item"><label>INT</label><select class="ss-select" id="statInt" onchange="calculatePoints()"></select></div>
                        <div class="ss-stat-item"><label>WIS</label><select class="ss-select" id="statWis" onchange="calculatePoints()"></select></div>
                        <div class="ss-stat-item"><label>CHA</label><select class="ss-select" id="statCha" onchange="calculatePoints()"></select></div>
                        <div id="pointsDisplay" class="ss-points-display ss-valid">Points Used: 0 / 27</div>
                    </div>
                </div>

                <div class="ss-form-group">
                    <label class="ss-label">Languages</label>
                    <input type="text" id="charLang" class="ss-input">
                </div>

                <!-- UPDATED SKILLS CONTAINER -->
                <div class="ss-form-group">
                    <label class="ss-label">Proficient Skills</label>
                    <div id="skillsGrid" class="ss-pill-container"></div>
                </div>

                <div class="ss-form-group">
                    <label class="ss-label">Expertise</label>
                    <div id="expertiseGrid" class="ss-pill-container"></div>
                </div>

                <div class="ss-form-group">
                    <label class="ss-label">Tools</label>
                    <textarea id="charTools" class="ss-textarea" rows="2"></textarea>
                </div>

                <div class="ss-form-group">
                    <label class="ss-label">Feats</label>
                    <textarea id="charFeats" class="ss-textarea" rows="2"></textarea>
                </div>

                <div class="ss-form-group">
                    <label class="ss-label">Other</label>
                    <textarea id="charOther" class="ss-textarea" rows="2"></textarea>
                </div>
                
                <input type="hidden" id="sheetLink">
            </form>
        </div>

        <!-- RIGHT COLUMN: OUTPUT -->
        <div class="ss-output-panel">
            <div class="ss-section-header">3. Output</div>
            <button id="btnUpdate" class="ss-btn ss-btn-primary" onclick="generateOutput()" style="margin-bottom:10px;">↻ Generate</button>
            <button class="ss-btn ss-btn-green" onclick="copyToClipboard()">Copy</button>
            <textarea id="output" class="ss-output-area" readonly placeholder="Output will appear here..."></textarea>
        </div>

    </div> <!-- End Grid Container -->
</div>

<div id="toast" class="ss-toast">Copied to Clipboard!</div>

<script>
(function() {
    // --- DATA LISTS ---
    const classData = {
        "Artificer": ["Alchemist", "Armorer", "Artillerist", "Battle Smith", "Cartographer"],
        "Barbarian": ["Ancestral Guardian", "Battlerager", "Beast", "Berserker", "Giant", "Juggernaut", "Storm Herald", "Totem Warrior", "Zealot", "Wild Magic", "Belly Brewer", "Carrion Raven", "Experiment", "Wild Heart", "Infernal", "Muscle Wizard", "World Tree"],
        "Bard": ["Creation", "Eloquence", "Glamour", "Lore", "Road", "Spirits", "Swords", "Tragedy", "Valor", "Whispers", "Cuisine", "Dance", "Masks", "Mercantile", "Moon", "Requiems", "Whistles", "Fleshweaving"],
        "Cleric": ["Arcana", "Blood", "Community", "Death", "Forge", "Grave", "Knowledge", "Life", "Light", "Moon", "Nature", "Night", "Order", "Peace", "Tempest", "Trickery", "Twilight", "Festus", "Harvest", "Inquisition", "War"],
        "Druid": ["Dreams", "Land", "Moon", "Shepherd", "Spores", "Stars", "Blighted", "Dragons", "Old Ways", "Petal", "Sea", "Warden", "Wicker", "Wildfire", "Hive"],
        "Paladin": ["Conquest", "Devotion", "Glory", "Redemption", "Ancients", "Crown", "Open Sea", "Watchers", "Vengeance", "Oathbreaker", "Castigation", "Noble Genies", "Revelry", "River", "Spelldrinker", "Zeal", "Harvest"],
        "Fighter": ["Arcane Archer", "Battle Master", "Cavalier", "Champion", "Echo Knight", "Eldritch Knight", "Psi Warrior", "Banneret", "Rune Knight", "Samurai", "Barrow Guard", "Scofflaw", "Spirit Fused", "Steel Hawk"],
        "Monk": ["Ascendant Dragon", "Astral Self", "Cobalt Soul", "Drunken Master", "Elements", "Kensei", "Long Death", "Mercy", "Open Hand", "Shadow", "Sun Soul", "Aether", "Pestilent Haze", "Sheep Dragon Shepherd", "Street"],
        "Ranger": ["Beast Master", "Drakewarden", "Fey Wanderer", "Gloom Stalker", "Horizon Walker", "Hunter", "Monster Slayer", "Swarmkeeper", "Corrupter", "Grim Harbinger", "Rocborne", "Winter Walker"],
        "Rogue": ["Arcane Trickster", "Assassin", "Inquisitive", "Mastermind", "Phantom", "Scout", "Soulknife", "Swashbuckler", "Thief", "Arachnoid Stalker", "Grim Surgeon", "Misfortune", "Scion of the Three", "Sinner", "Waxwork"],
        "Sorcerer": ["Aberrant Mind", "Clockwork Soul", "Divine Soul", "Draconic Bloodline", "Lunar Sorcery", "Runechild", "Shadow Magic", "Storm Sorcery", "Wild Magic", "Crimson", "Desert Soul", "Oni", "Spellfire"],
        "Warlock": ["Archfey", "Celestial", "Fathomless", "Fiend", "Genie", "Great Old One", "Hexblade", "Undead", "Undying", "Future You", "Great Fool", "Horned King", "Lantern", "Many", "Predator"],
        "Wizard": ["Bladesinging", "Blood Magic", "Chronurgy", "Graviturgy", "Scribes", "Abjuration", "Conjuration", "Divination", "Enchantment", "Evocation", "Illusion", "Necromancy", "Transmutation", "War Magic", "Leyline", "Occultist", "Origami", "Philosopher", "Wand", "Biomancy"]
    };

    const skillsList = [
        "Acrobatics", "Animal Handling", "Arcana", "Athletics", "Deception", "History", "Insight", "Intimidation",
        "Investigation", "Medicine", "Nature", "Perception", "Performance", "Persuasion", "Religion", "Sleight of Hand", "Stealth", "Survival"
    ];

    const speciesList = [
        "Aarakocra (EEPC)", "Aarakocra (MPMM)", "Aasimar (PHB'24)", "Accursed (GH:PG'24)", "Arisen (GH:PG'24)", "Ashborn (TCM'24)", "Astral Elf (AAG)", 
        "Autognome (AAG)", "Azureborn (TCM'24)", "Bogborn (TCM'24)", "Boggart (LFL)", "Bugbear (ERLW)", "Bugbear (MPMM)", "Bugbear (VGM)", "Canisar (OSW:HAP)", 
        "Centaur (GGR)", "Centaur (MOT)", "Centaur (MPMM)", "Cervan (Grove) (HWCS)", "Cervan (HWCS)", "Cervan (Pronghorn) (HWCS)", "Changeling (EFA)", 
        "Changeling (ERLW)", "Changeling (MPMM)", "Cnidaran (HGtMH)", "Cnidaran (Nematocyst) (HGtMH)", "Cnidaran (Shimmerskin) (HGtMH)", "Corvum (Dusk) (HWCS)", 
        "Corvum (HWCS)", "Corvum (Kindled) (HWCS)", "Curseborn (TCM'24)", "Custom Lineage (TCE)", "Cyclopian (HGtMH)", "Dara (Blue) (O:TTG)", "Dara (O:TTG)", 
        "Dara (Red) (O:TTG)", "Deep Gnome (MPMM)", "Deepborn (TCM'24)", "Dhampir (ABH)", "Dhampir (GH:PG'24)", "Dhampir (VRGR)", "Disembodied (GH:PG'24)", 
        "Downcast (GH:PG'24)", "Dragonborn (Base) (PHB'14)", "Dragonborn (Chromatic) (FTD)", "Dragonborn (Draconblood) (EGW)", "Dragonborn (Gem) (FTD)", 
        "Dragonborn (GH:PG'24)", "Dragonborn (Metallic) (FTD)", "Dragonborn (PHB'24)", "Dragonborn (Ravenite) (EGW)", "Dreamer (GH:PG'24)", "Duergar (MPMM)", 
        "Dwarf (Duergar) (MTF)", "Dwarf (GH:PG'24)", "Dwarf (Hill) (PHB'14)", "Dwarf (Mark of Warding) (ERLW)", "Dwarf (Mountain) (PHB'14)", "Dwarf (PHB'24)", 
        "Eladrin (MPMM)", "Elf (Courage) (O:TTG)", "Elf (Eladrin) (DMG'14)", "Elf (Eladrin) (MTF)", "Elf (Fury) (O:TTG)", "Elf (GH:PG'24)", "Elf (Harmony) (O:TTG)", 
        "Elf (LFL)", "Elf (Mark of Shadow) (ERLW)", "Elf (Nature) (O:TTG)", "Elf (O:TTG)", "Elf (Pallid) (EGW)", "Elf (PHB'24)", "Elf (Purity) (O:TTG)", 
        "Elf (Sea) (MTF)", "Elf (Selflessness) (O:TTG)", "Elf (Shadar-kai) (MTF)", "Etherean (TGS2)", "Faerie (LFL)", "Fairy (MPMM)", "Fairy (WBtW)", 
        "Firbolg (MPMM)", "Firbolg (VGM)", "Flamekin (LFL)", "Gallus (Bright) (HWCS)", "Gallus (Huden) (HWCS)", "Gallus (HWCS)", "Geleton (TGS2)", 
        "Genasi (Air) (EEPC)", "Genasi (Air) (MPMM)", "Genasi (Earth) (EEPC)", "Genasi (Earth) (MPMM)", "Genasi (EEPC)", "Genasi (Fire) (EEPC)", 
        "Genasi (Fire) (MPMM)", "Genasi (MPMM)", "Genasi (Water) (EEPC)", "Genasi (Water) (MPMM)", "Geppettin (VSS:PP)", "Giff (AAG)", "Gith (Githyanki) (MTF)", 
        "Gith (Githzerai) (MTF)", "Gith (MTF)", "Githyanki (MPMM)", "Githzerai (MPMM)", "Gnarlborn (TCM'24)", "Gnome (Deep) (MTF)", "Gnome (Deep/Svirfneblin) (SCAG)", 
        "Gnome (GH:PG'24)", "Gnome (Mark of Scribing) (ERLW)", "Gnome (PHB'24)", "Gobboc (HGtMH)", "Goblin (Dankwood) (AWM)", "Goblin (ERLW)", "Goblin (GGR)", 
        "Goblin (MPMM)", "Goblin (VGM)", "Goliath (PHB'24)", "Golynn (HGtMH)", "Graveborn (TCM'24)", "Grudgel (GH:PG'24)", "Grung (OGA)", "Hadozee (AAG)", 
        "Half-Elf (Base) (PHB'14)", "Half-Elf (PHB'14)", "Half-Elf (Variant; Aquatic Elf Descent) (SCAG)", "Half-Elf (Variant; Drow Descent) (SCAG)", 
        "Half-Elf (Variant; Mark of Detection) (ERLW)", "Half-Elf (Variant; Mark of Storm) (ERLW)", "Half-Elf (Variant; Moon Elf or Sun Elf Descent) (SCAG)", 
        "Half-Elf (Variant; Wood Elf Descent) (SCAG)", "Half-Orc (Base) (PHB'14)", "Half-Orc (PHB'14)", "Half-Orc (Variant; Mark of Finding) (ERLW)", 
        "Halfling (GH:PG'24)", "Halfling (Ghostwise) (SCAG)", "Halfling (Lightfoot) (PHB'14)", "Halfling (Lotusden) (EGW)", "Halfling (Mark of Healing) (ERLW)", 
        "Halfling (Mark of Hospitality) (ERLW)", "Halfling (PHB'24)", "Halfling (Stout) (PHB'14)", "Harengon (MPMM)", "Harengon (WBtW)", "Harvestborn (TCM'24)", 
        "Hederan (OSW:HAP)", "Hedge (HWCS)", "Hexblood (VRGR)", "Hobgoblin (ERLW)", "Hobgoblin (MPMM)", "Hobgoblin (VGM)", "Human (Base) (PHB'14)", 
        "Human (GH:PG'24)", "Human (Mark of Handling) (ERLW)", "Human (Mark of Making) (ERLW)", "Human (Mark of Passage) (ERLW)", "Human (Mark of Sentinel) (ERLW)", 
        "Human (PHB'24)", "Human (Variant; Mark of Finding) (ERLW)", "Jerbeen (HWCS)", "Kalashtar (EFA)", "Kalashtar (ERLW)", "Kender (DSotDQ)", "Kenku (MPMM)", 
        "Kenku (VGM)", "Khoravar (EFA)", "Kithkin (LFL)", "Kobold (MPMM)", "Kobold (VGM)", "Laneshi (GH:PG'24)", "Leonin (MOT)", "Lizardfolk (MPMM)", 
        "Lizardfolk (VGM)", "Locathah (LR)", "Lorwyn Changeling (LFL)", "Lotol (HGtMH)", "Loxodon (GGR)", "Luma (HWCS)", "Luma (Sable) (HWCS)", 
        "Luma (Sera) (HWCS)", "Mandrake (VSS:PP)", "Mapach (HWCS)", "Minotaur (GGR)", "Minotaur (MOT)", "Minotaur (MPMM)", "Mycelian (HGtMH)", 
        "Nakudama (O:TTG)", "Ogresh (GH:PG'24)", "Ombrask (HGtMH)", "Oozekin (HGtMH)", "Opteran (HGtMH)", "Orc (PHB'24)", "Owlin (SCC)", "Plagueborn (TCM'24)", 
        "Plasmoid (AAG)", "Rakin (HGtMH)", "Rakin (Posskin) (HGtMH)", "Rakin (Tanukin) (HGtMH)", "Rakin (Urkin) (HGtMH)", "Raptor (HWCS)", 
        "Raptor (Maran) (HWCS)", "Raptor (Mistral) (HWCS)", "Reborn (VRGR)", "Relicborn (TCM'24)", "Rimekin (LFL)", "Satyr (MOT)", "Satyr (MPMM)", 
        "Sea Elf (MPMM)", "Shadar-Kai (MPMM)", "Shifter (Beasthide) (ERLW)", "Shifter (EFA)", "Shifter (ERLW)", "Shifter (Longtooth) (ERLW)", 
        "Shifter (MPMM)", "Shifter (Swiftstride) (ERLW)", "Shifter (Wildhunt) (ERLW)", "Silkborn (TCM'24)", "Simic Hybrid (GGR)", "Snowborn (OSW:HAP)", 
        "Stoneborn (TCM'24)", "Strig (HWCS)", "Strig (Stout) (HWCS)", "Strig (Swift) (HWCS)", "Tabaxi (MPMM)", "Tabaxi (VGM)", "Tarandus (OSW:HAP)", 
        "The Disembodied (GH:PP)", "Threadborn (TCM'24)", "Thri-kreen (AAG)", "Tiefling (PHB'24)", "Tortle (MPMM)", "Tortle (TTP)", "Triton (MOT)", 
        "Triton (MPMM)", "Triton (VGM)", "Vedalken (GGR)", "Verdan (AI)", "Vulpin (HWCS)", "Warforged (EFA)", "Warforged (ERLW)", "Wechselkind (GH:PG'24)", 
        "Wechselkind (GH:PP)", "Wulven (GH:PG'24)", "Yuan-Ti (MPMM)", "Yuan-ti Pureblood (VGM)"
    ];

    const bgList = [
        "Aberrant Heir", "Acolyte", "Amnesiac", "Archaeologist", "Artisan", "Carouser", "Charlatan", "Chondathan Freebooter", "Criminal", "Crimson Aspirant", "Crossroads Gambler", "Cultist", "Dead Magic Dweller", "Dragon Cultist", "Druskenvald Dweller", "Emerald Enclave Caretaker", "Entertainer", "Experiment", "Farmer", "Flaming Fist Mercenary", "Genie Touched", "Ghostlight Passenger", "Guard", "Guide", "Harper", "Hermit", "House Agent", "House Cannith Heir", "House Deneith Heir", "House Ghallanda Heir", "House Jorasco Heir", "House Kundarak Heir", "House Lyrandar Heir", "House Medani Heir", "House Orien Heir", "House Phiarlan Heir", "House Sivis Heir", "House Tharashk Heir", "House Thuranni Heir", "House Vadalis Heir", "Ice Fisher", "Inquisitive", "Knight of the Gauntlet", "Lords' Alliance Vassal", "Merchant", "Moonwell Pilgrim", "Mulhorandi Tomb Raider", "Mythalkeeper", "Night Stalker", "Noble", "Purple Dragon Squire", "Rashemi Wanderer", "Reflected Wanderer", "Rest Warden", "Reveler", "Sage", "Sailor", "Scholar of the Forbidden", "Scribe", "Shadowmasters Exile", "Soldier", "Spellfire Initiate", "Vampire Devotee", "Vampire Survivor", "Wayfarer", "Wicker Weaver", "Zhentarim Mercenary"
    ];

    const pointBuyCosts = { 8:0, 9:1, 10:2, 11:3, 12:4, 13:5, 14:7, 15:9 };

    // --- MAIN INITIALIZATION FUNCTION ---
    function init() {
        try {
            populateSelect('charSpecies', speciesList, true);
            populateSelect('charBackground', bgList, true);
            populateStats();
            populateCheckGrid('skillsGrid', 'skill_');
            populateCheckGrid('expertiseGrid', 'exp_');
            addClassRow(); // Default
            generateOutput();
        } catch (e) {
            console.error("Initialization Error:", e);
        }
    }

    // --- HELPERS ---
    function cleanSubclassName(name) {
        if (!name) return "";
        let clean = name.toLowerCase();
        const junk = ["domain", "college of", "circle of the", "circle of", "path of the", "path of", "archetype", "way of the", "way of", "oath of", "conclave", "patron", "origin", "school of", "tradition", "the"];
        junk.forEach(j => { clean = clean.replace(j, "").trim(); });
        return clean;
    }

    function populateSelect(id, options, hasOther) {
        const select = document.getElementById(id);
        if(!select) return; 
        select.innerHTML = '<option value="">Select...</option>';
        options.sort().forEach(opt => {
            const el = document.createElement('option'); el.value = opt; el.innerText = opt; select.appendChild(el);
        });
        if (hasOther) {
            const el = document.createElement('option'); el.value = "Other"; el.innerText = "Other (Type below)"; select.appendChild(el);
        }
        
        select.addEventListener('change', function() {
            const wrapper = this.parentElement;
            const otherInput = wrapper.querySelector('.other-input');
            if (this.value === "Other") { wrapper.classList.add('show-other'); otherInput.focus(); } 
            else { wrapper.classList.remove('show-other'); otherInput.value = ""; }
            window.generateOutput();
        });
        const otherInput = select.parentElement.querySelector('.other-input');
        if(otherInput) otherInput.addEventListener('input', window.generateOutput);
    }

    function populateStats() {
        const stats = ['Str', 'Dex', 'Con', 'Int', 'Wis', 'Cha'];
        stats.forEach(s => {
            const select = document.getElementById('stat' + s);
            if(!select) return;
            select.innerHTML = '';
            for (let i = 8; i <= 15; i++) {
                const opt = document.createElement('option'); opt.value = i; opt.innerText = i; select.appendChild(opt);
            }
            select.value = 8;
        });
    }

    function populateCheckGrid(gridId, prefix) {
        const grid = document.getElementById(gridId);
        if(!grid) return;
        grid.innerHTML = '';
        skillsList.forEach(skill => {
            const item = document.createElement('div');
            item.className = 'ss-pill-item'; // UPDATED CLASS
            
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.value = skill;
            checkbox.id = prefix + skill.replace(/[^a-zA-Z0-9]/g, '');
            checkbox.addEventListener('change', window.generateOutput);

            const label = document.createElement('label');
            label.htmlFor = checkbox.id;
            label.innerText = skill;
            // label.style.cursor = 'pointer'; // Handled in CSS now
            
            item.appendChild(checkbox); item.appendChild(label); grid.appendChild(item);
        });
    }
    
    // --- NEW: CLEAR ALL FUNCTION (WITHOUT CONFIRM) ---
    window.clearAllData = function() {
        // 1. Reset standard form elements
        document.getElementById('charForm').reset();
        
        // 2. Clear manual inputs outside main loop or needing specific attention
        document.getElementById('charUrl').value = '';
        document.getElementById('sheetLink').value = '';
        document.getElementById('output').value = '';
        document.getElementById('statusMsg').innerText = '';

        // 3. Reset Classes (Remove extra rows, reset first row)
        const container = document.getElementById('classesContainer');
        container.innerHTML = '';
        addClassRow(); // Re-add default row

        // 4. Reset Stats to 8
        ['Str', 'Dex', 'Con', 'Int', 'Wis', 'Cha'].forEach(s => {
            const el = document.getElementById('stat'+s);
            if(el) el.value = 8;
        });
        calculatePoints();

        // 5. Reset Checkboxes (Pills)
        document.querySelectorAll('.ss-pill-item input').forEach(el => el.checked = false);

        // 6. Reset Selects/Others
        document.querySelectorAll('select').forEach(s => s.selectedIndex = 0);
        document.querySelectorAll('.other-input').forEach(i => i.value = '');
        document.querySelectorAll('.ss-input-combo').forEach(d => d.classList.remove('show-other'));

        // 7. Reset BG Bonuses
        document.getElementById('bgBonusInputs').innerHTML = '';
        document.getElementById('bgBonusInputs').classList.add('ss-hidden');

        generateOutput();
    };

    // EXPOSE GLOBAL FUNCTIONS (Required for HTML onclick events)
    window.addClassRow = function(defaultClass = "", defaultSub = "", defaultLvl = 1) {
        const container = document.getElementById('classesContainer');
        const row = document.createElement('div');
        row.className = 'ss-class-row';
        
        let classOpts = '<option value="">Class...</option>';
        Object.keys(classData).sort().forEach(c => classOpts += `<option value="${c}">${c}</option>`);
        classOpts += '<option value="Other">Other (Type below)</option>';

        row.innerHTML = `
            <div class="ss-class-controls">
                <select class="ss-select cls-select" onchange="handleClassChange(this)">${classOpts}</select>
                <select class="ss-select sub-select" disabled><option value="">Subclass...</option></select>
                <label style="font-size:0.7rem; margin:0 2px;">Lvl</label>
                <input type="number" class="ss-input lvl-input" value="${defaultLvl}" min="1" max="20" onchange="generateOutput()">
                <button type="button" class="ss-btn ss-btn-remove" onclick="removeClassRow(this)">x</button>
            </div>
            <div class="ss-other-inputs-row">
                <input type="text" class="ss-input cls-other" placeholder="Class Name..." oninput="generateOutput()">
                <input type="text" class="ss-input sub-other" placeholder="Subclass Name..." oninput="generateOutput()">
            </div>
        `;
        container.appendChild(row);

        if (defaultClass) {
            const clsSelect = row.querySelector('.cls-select');
            let found = false;
            for(let opt of clsSelect.options) {
                if(opt.value === defaultClass) { clsSelect.value = defaultClass; found = true; break; }
            }
            if(!found) { clsSelect.value = "Other"; row.querySelector('.cls-other').value = defaultClass; }
            
            handleClassChange(clsSelect);

            const subSelect = row.querySelector('.sub-select');
            found = false;
            if(defaultSub) {
                const cleanImport = cleanSubclassName(defaultSub);
                for(let opt of subSelect.options) {
                    const cleanOpt = cleanSubclassName(opt.value);
                    if(cleanOpt && (cleanImport.includes(cleanOpt) || cleanOpt.includes(cleanImport))) { 
                        subSelect.value = opt.value; found = true; break; 
                    }
                }
                if(!found) {
                    subSelect.value = "Other"; row.querySelector('.sub-other').value = defaultSub;
                    row.querySelector('.ss-other-inputs-row').classList.add('ss-show');
                }
            }
        }
    };

    window.removeClassRow = function(btn) {
        const container = document.getElementById('classesContainer');
        if (container.children.length > 1) {
            btn.closest('.ss-class-row').remove(); generateOutput();
        } else {
            const row = btn.closest('.ss-class-row');
            row.querySelector('.cls-select').value = "";
            row.querySelector('.sub-select').innerHTML = '<option value="">Subclass...</option>';
            row.querySelector('.sub-select').disabled = true;
            row.querySelector('.lvl-input').value = 1;
            row.querySelector('.ss-other-inputs-row').classList.remove('ss-show');
            generateOutput();
        }
    };

    window.handleClassChange = function(selectElement) {
        const row = selectElement.closest('.ss-class-row');
        const subSelect = row.querySelector('.sub-select');
        const otherRow = row.querySelector('.ss-other-inputs-row');
        const className = selectElement.value;

        subSelect.innerHTML = '<option value="">Subclass...</option>';
        subSelect.disabled = false;
        
        if (className === "Other") {
            otherRow.classList.add('ss-show'); subSelect.innerHTML = '<option value="Other">Other</option>'; subSelect.value = "Other";
        } else {
            if (subSelect.value !== "Other") otherRow.classList.remove('ss-show');
            if (className && classData[className]) {
                classData[className].sort().forEach(sub => {
                    const opt = document.createElement('option'); opt.value = sub; opt.innerText = sub; subSelect.appendChild(opt);
                });
            }
            const otherOpt = document.createElement('option'); otherOpt.value = "Other"; otherOpt.innerText = "Other (Type below)"; subSelect.appendChild(otherOpt);
        }

        subSelect.onchange = function() {
            if (this.value === "Other" || className === "Other") otherRow.classList.add('ss-show');
            else otherRow.classList.remove('ss-show');
            generateOutput();
        };
        generateOutput();
    };

    window.updateBgBonusInputs = function() {
        const type = document.getElementById('bgBonusType').value;
        const container = document.getElementById('bgBonusInputs');
        container.innerHTML = '';
        container.classList.remove('ss-hidden');

        if (type === 'none') { container.classList.add('ss-hidden'); return; }

        const abilities = ["Str", "Dex", "Con", "Int", "Wis", "Cha"];
        if (type === '2_1') {
            createBonusSelect(container, abilities, "+2"); createBonusSelect(container, abilities, "+1");
        } else if (type === '1_1_1') {
            createBonusSelect(container, abilities, "+1"); createBonusSelect(container, abilities, "+1"); createBonusSelect(container, abilities, "+1");
        }
        generateOutput();
    };

    function createBonusSelect(container, options, labelText) {
        const wrapper = document.createElement('div');
        wrapper.style.display = 'flex'; wrapper.style.flexDirection = 'column'; wrapper.style.flex = '1';
        const label = document.createElement('label');
        label.innerText = labelText; label.style.fontSize = '0.7em'; label.style.color = '#f59e0b';
        const select = document.createElement('select');
        select.className = 'ss-select'; select.innerHTML = '<option value="">-</option>';
        options.forEach(opt => {
            const el = document.createElement('option'); el.value = opt; el.innerText = opt; select.appendChild(el);
        });
        select.addEventListener('change', generateOutput);
        wrapper.appendChild(label); wrapper.appendChild(select); container.appendChild(wrapper);
    }

    window.calculatePoints = function() {
        const stats = ['Str', 'Dex', 'Con', 'Int', 'Wis', 'Cha'];
        let total = 0;
        stats.forEach(s => {
            const el = document.getElementById('stat' + s);
            if(el) {
                const val = parseInt(el.value); 
                total += pointBuyCosts[val] || 0;
            }
        });
        const display = document.getElementById('pointsDisplay');
        display.innerText = `Points Used: ${total} / 27`;
        if (total > 27) { display.classList.remove('ss-valid'); display.classList.add('ss-invalid'); } 
        else { display.classList.remove('ss-invalid'); display.classList.add('ss-valid'); }
        generateOutput();
    };

    window.fetchCharacter = async function() {
        const urlInput = document.getElementById('charUrl').value.trim();
        const status = document.getElementById('statusMsg');
        if (!urlInput) { status.innerText = "Please enter a URL."; return; }
        status.innerText = "Fetching data...";
        const idMatch = urlInput.match(/characters\/(\d+)/);
        if (!idMatch) { status.innerText = "Error: Invalid URL."; return; }
        const charId = idMatch[1];
        document.getElementById('sheetLink').value = urlInput;

        try {
            const targetUrl = `https://character-service.dndbeyond.com/character/v5/character/${charId}`;
            const proxyUrl = `https://corsproxy.io/?` + encodeURIComponent(targetUrl);
            const response = await fetch(proxyUrl);
            if (!response.ok) throw new Error("Character might be private.");
            const json = await response.json();
            if (!json.data) throw new Error("No data found");
            populateForm(json.data, urlInput);
            status.innerText = "Data loaded successfully!"; status.style.color = "#4ade80";
        } catch (err) {
            console.error(err); status.innerText = "Error: Could not fetch the URL. Your character might be private. Make it public by going to character manager, then first page home then scroll down to the bottom and choose public."; status.style.color = "#ef4444";
        } finally { setTimeout(() => status.innerText = "", 10000); }
    };

    function populateForm(data, url) {
        document.getElementById('charName').value = data.name || "";
        document.getElementById('sheetLink').value = url;
        const container = document.getElementById('classesContainer'); 
        container.innerHTML = '';

        // 1. Classes
        if (data.classes && data.classes.length > 0) {
            data.classes.forEach(cls => {
                const cName = cls.definition.name;
                const cSub = cls.subclassDefinition ? cls.subclassDefinition.name : "";
                const cLvl = cls.level;
                addClassRow(cName, cSub, cLvl);
            });
        } else { addClassRow(); }

        // 2. Race & Background
        if (data.race) { const raceName = data.race.fullName || data.race.baseName; setDropdownValue('charSpecies', raceName, speciesList); }
        if (data.background && data.background.definition) { setDropdownValue('charBackground', data.background.definition.name, bgList); }

        // 3. Stats
        const baseStats = calculateBaseStats(data);
        const stats = ['Str', 'Dex', 'Con', 'Int', 'Wis', 'Cha'];
        stats.forEach(k => { document.getElementById('stat' + k).value = baseStats[k.toLowerCase()]; });
        calculatePoints();

        // 4. Languages
        document.getElementById('charLang').value = parseModifiers(data, 'language').join(", ");

        // 5. Skills (Now using the fixed parser)
        const ddbSkills = parseModifiers(data, 'proficiency', true);
        const ddbExpertise = parseModifiers(data, 'expertise');
        
        // Reset checks
        document.querySelectorAll('#skillsGrid input').forEach(cb => cb.checked = false);
        document.querySelectorAll('#expertiseGrid input').forEach(cb => cb.checked = false);
        
        skillsList.forEach(s => {
            const safeId = s.replace(/[^a-zA-Z0-9]/g, '');
            if (ddbSkills.some(ds => ds === s)) { 
                const cb = document.getElementById('skill_' + safeId); 
                if (cb) cb.checked = true; 
            }
            if (ddbExpertise.some(de => de === s)) { 
                const cb = document.getElementById('exp_' + safeId); 
                if (cb) cb.checked = true; 
            }
        });

        // 6. Tools
        document.getElementById('charTools').value = parseModifiers(data, 'proficiency', false, true).join(", ");
        
        // 7. Feats (With Junk Filter)
        const junkKeywords = [
            "Ability Score Increase", 
            "Weapon Mastery", 
            "Dark Bargain", 
            "Spellcasting",
            "Pact Magic", "Ability Score Improvements"
        ];

        const feats = data.feats
            .map(f => f.definition.name)
            .filter(name => {
                // Return FALSE if the name contains any junk keyword
                return !junkKeywords.some(junk => name.includes(junk));
            })
            .join(", ");
            
        document.getElementById('charFeats').value = feats;
        generateOutput();
    }

    function setDropdownValue(id, value, list) {
        const select = document.getElementById(id);
        const wrapper = select.parentElement;
        const otherInput = wrapper.querySelector('.other-input');
        if(!value) return;
        let found = false;
        for (let i = 0; i < select.options.length; i++) {
            const optVal = select.options[i].value;
            if (optVal && (value.includes(optVal) || optVal.includes(value))) {
                select.selectedIndex = i; wrapper.classList.remove('show-other'); found = true; break;
            }
        }
        if (!found) { select.value = "Other"; wrapper.classList.add('show-other'); otherInput.value = value; }
    }

    function calculateBaseStats(data) {
        let stats = { str: 8, dex: 8, con: 8, int: 8, wis: 8, cha: 8 };
        if (data.stats) { data.stats.forEach(s => { const map = {1:'str', 2:'dex', 3:'con', 4:'int', 5:'wis', 6:'cha'}; if(map[s.id]) stats[map[s.id]] = s.value || 8; }); }
        const bonusMap = { str: 0, dex: 0, con: 0, int: 0, wis: 0, cha: 0 };
        if (data.modifiers) {
            Object.values(data.modifiers).flat().forEach(m => {
                if (m.type === 'bonus' && m.subType === 'ability-score') {
                    const map = {1:'str', 2:'dex', 3:'con', 4:'int', 5:'wis', 6:'cha'}; if(map[m.statId]) bonusMap[map[m.statId]] += m.value;
                }
            });
        }
        Object.keys(stats).forEach(k => { stats[k] = Math.min(Math.max(stats[k] - bonusMap[k], 8), 15); });
        return stats;
    }

    function parseModifiers(data, type, isSkill = false, isTool = false) {
        let results = [];
        const allMods = Object.values(data.modifiers || {}).flat();
        
        // D&D Beyond Magic Numbers:
        // EntityTypeId 1958004211 = Skills
        // EntityTypeId 174869515 = Armor (Shields are ID 4 here)
        const SKILL_ENTITY_TYPE = 1958004211;

        const ddbSkills = {2:"Athletics",3:"Acrobatics",4:"Sleight of Hand",5:"Stealth",6:"Arcana",7:"History",8:"Investigation",9:"Nature",10:"Religion",11:"Animal Handling",12:"Insight",13:"Medicine",14:"Perception",15:"Survival",16:"Deception",17:"Intimidation",18:"Performance",19:"Persuasion"};

        allMods.forEach(m => {
            if (m.type === type) {
                let name = m.friendlySubtypeName || m.friendlyTypeName || "";
                
                if (isSkill) {
                    // FIX: Only map the ID to a name if it is ACTUALLY a skill entity
                    if (m.entityTypeId === SKILL_ENTITY_TYPE && m.entityId && ddbSkills[m.entityId]) {
                        name = ddbSkills[m.entityId];
                    } 
                    // Fallback for custom entries that might just be text
                    else if (name && name.includes(":")) {
                        name = name.split(":").pop().trim();
                    }
                    
                    // Only add if we found a valid name AND that name is in our allowed list
                    if(name && skillsList.includes(name)) {
                        if (!results.includes(name)) results.push(name);
                    }
                } else if (isTool) {
                    if(m.entityTypeId === 2103445194 || name.toLowerCase().match(/(tool|kit|supplies|instrument)/)) {
                        if(name && !results.includes(name)) results.push(name);
                    }
                } else { 
                    if(name && !results.includes(name)) results.push(name); 
                }
            }
        });
        return results;
    }

    window.generateOutput = function() {
        const getVal = (id) => { const el = document.getElementById(id); return el ? el.value : ''; };
        const getCombo = (selId, inpId) => { const sel = document.getElementById(selId); return (sel.value === "Other" || sel.value === "") ? document.getElementById(inpId).value : sel.value; };
        
        const num = getVal('charNum') || '##';
        const name = getVal('charName') || 'Name';

        let classArr = [];
        document.querySelectorAll('.ss-class-row').forEach(row => {
            const clsSel = row.querySelector('.cls-select');
            const subSel = row.querySelector('.sub-select');
            let cName = clsSel.value === 'Other' ? row.querySelector('.cls-other').value : clsSel.value;
            let sName = subSel.value === 'Other' ? row.querySelector('.sub-other').value : subSel.value;
            let lvl = row.querySelector('.lvl-input').value;
            if (cName) { let str = `${cName} ${lvl}`; if (sName) str += ` (${sName})`; classArr.push(str); }
        });
        const classes = classArr.join(" / ");
        const species = getCombo('charSpecies', 'charSpeciesOther');
        let bg = getCombo('charBackground', 'charBgOther');

        const bgType = document.getElementById('bgBonusType').value;
        if(bgType !== 'none'){
            const selects = document.querySelectorAll('#bgBonusInputs select');
            let bonuses = [];
            selects.forEach(s => { if(s.value) { const label = s.previousElementSibling.innerText; bonuses.push(`${label} ${s.value}`); } });
            if(bonuses.length > 0) bg += ` [${bonuses.join(', ')}]`;
        }

        const scores = `${getVal('statStr')} Str / ${getVal('statDex')} Dex / ${getVal('statCon')} Con / ${getVal('statInt')} Int / ${getVal('statWis')} Wis / ${getVal('statCha')} Cha`;
        const getChecked = (id) => Array.from(document.querySelectorAll(`#${id} input:checked`)).map(cb => cb.value).join(", ");
        const skills = getChecked('skillsGrid');
        const expertise = getChecked('expertiseGrid');

        let md = `**Character Number:** ${num}
**Name:** ${name}
**Class:** ${classes}
**Species:** ${species}
**Background & Ability Score Bonuses:** ${bg}

**Ability Scores:** (without bonuses) ${scores}

**Languages:** ${getVal('charLang')}
**Skills:** ${skills}
**Expertise:** ${expertise}
**Tools:** ${getVal('charTools')}
**Feats:** ${getVal('charFeats')}
**Other:** ${getVal('charOther')}`;

        if (getVal('sheetLink')) md += `\n**Link:** <${getVal('sheetLink')}>`;

        document.getElementById('output').value = md;
        const btn = document.getElementById('btnUpdate');
        if(btn && document.activeElement === btn) {
            const originalText = btn.innerHTML;
            btn.innerHTML = "✓ Updated!"; setTimeout(() => { btn.innerHTML = originalText; }, 2000);
        }
    };

    window.copyToClipboard = function() {
        const output = document.getElementById("output");
        output.select();
        navigator.clipboard.writeText(output.value);
        const toast = document.getElementById("toast");
        toast.className = "ss-toast show";
        setTimeout(() => toast.className = toast.className.replace("show", ""), 3000);
    };

    // RUN INITIALIZATION IMMEDIATELY
    init();
})();
</script>